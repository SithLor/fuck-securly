const e="https://deviceconsole.securly.com",t=chrome.runtime.getManifest().version,o="/chrome/handle",n="/chrome/fire",s=200,r=412,i="chrome_app_list",a="authenticate",c="get_org_url",l="chrome_hand_raised",d="chrome_idle_status_change",u="chrome_login",h="chrome_lost_mode_on",m="chrome_send_message",g="chrome_call",f="chrome_windows_agent_info",p="chrome_auth_confirm",w="chrome_change_device_name",v="chrome_change_server_url",b="chrome_device_not_found",y="chrome_get_location",k="chrome_login_confirmation",C="chrome_update_logging",I="chrome_enable_lost_mode",S="chrome_blocking_plan",T="chrome_chat_message",_="chrome_session",E="chrome_session_update",U="chrome_clear_raised_hand",A="chrome_close_app",L="chrome_close_tab",R="chrome_focus_tab",N="chrome_get_tabs",M="chrome_lock_screen",P="chrome_open_site",q="chrome_get_screenshot",x="chrome_screen_share",O="chrome_site_lock",D="chrome_teacher_message",H="chrome_teacher_screen_share",W="chrome_unlock",B="chrome_windows_agent_upgrade",F="device not found",J="disconnected port",z="chrome_upgrade",j="blocklist",V="lostModeType",G="isChromeBook",X="blockingPlanUrls",Q="blockingPlanName",Y="blockType",$="deviceName",Z="allowContactAdmin",K="allowCaptureScreen",ee="notificationInterval",te="orgName",oe="screenBlockMessage",ne="serverUrl",se="udid",re="updateCheckDate",ie="visitedUrls",ae="whitelist",ce="block",le="none",de="Allow_only",ue="Block_only",he="repeatLogin",me="restartPolling",ge="restartForUpgrade",fe="sendUrls",pe="ping",we="showWarning",ve="windowsAgentConnect",be="X-TabPilot-RegCode",ye=8e4,ke=-1,Ce="session_start",Ie="screen_sharing",Se="Class session is active",Te="update_available",_e="throttled",Ee={},Ue=["accounts.google.com","accounts.youtube.com","canvaslms.com","instructure.com/login"],Ae=["classroom.google.com","docs.google.com","assignments.google.com"];var Le=null,Re=null,Ne=null;const Me=!1,Pe=!0,qe="com.securly.classroom.windows.agent",xe="com.securly.classroom_native_host",Oe="win_not_allowed";function De(e){return new Promise((t,o)=>{chrome.tabs.query(e,function(e){chrome.runtime.lastError&&console.log("Cannot get chrome tabs: "+chrome.runtime.lastError.message),t(e)})})}function He(){return new Promise(e=>{chrome.windows.getAll({populate:!0},t=>{e(t)})})}async function We(e){return new Promise((t,o)=>{chrome.windows.get(e,e=>{chrome.runtime.lastError?o(chrome.runtime.lastError.message):t(e)})})}function Be(){return new Promise(e=>{chrome.windows.getLastFocused(null,function(t){e(t)})})}function Fe(e){return new Promise(t=>{const o={focused:!0,state:"normal",type:"normal"};e&&(o.url=e),chrome.windows.create(o,e=>{t(e)})})}async function Je(e){const t={focused:!0,state:"fullscreen"};try{await ze(e,t)}catch(e){console.log("Error while update to fullscreen: "+chrome.runtime.lastError.message)}}async function ze(e,t){return new Promise((o,n)=>{chrome.windows.update(e,t,function(e){chrome.runtime.lastError?n(chrome.runtime.lastError.message):o()})})}async function je(e){return new Promise((t,o)=>{chrome.tabs.get(e,function(e){chrome.runtime.lastError&&o(chrome.runtime.lastError.message),t(e)})})}function Ve(e){return new Promise((t,o)=>{chrome.tabs.create(e,function(e){chrome.runtime.lastError?o(chrome.runtime.lastError.message):t(e)})})}function Ge(e){return new Promise((t,o)=>{chrome.tabs.remove(e,function(){chrome.runtime.lastError&&console.log("Error closing tab: "+chrome.runtime.lastError.message),t()})})}async function Xe(e){const t=await je(e);if(t)try{const o=await We(t.windowId);await ze(o.id,{focused:!0}),await it(e,{active:!0})}catch(e){console.log("Error focusing tab: "+e)}else console.log("Not found tab with id="+e)}function Qe(){return new Promise((e,t)=>{chrome.tabs.captureVisibleTab(function(o){chrome.runtime.lastError&&t(chrome.runtime.lastError.message),void 0===o&&t("No screenshot captured"),e(o)})})}async function Ye(){return new Promise(e=>{chrome.storage.local.get(null,function(t){chrome.runtime.lastError&&(console.log("Error loading config from storage: "+chrome.runtime.lastError.message),e(new ht({}))),e(new ht(t))})})}async function $e(){return new Promise(e=>{chrome.storage.local.get(ie,t=>{chrome.runtime.lastError?(console.log("Failed to load urls from local storage"),e()):e(t[ie])})})}async function Ze(){return"function"==typeof getSubstitutedEmail?Promise.resolve(getSubstitutedEmail()):Pe&&chrome.identity?new Promise(e=>{const t=function(e){return e&&e.trim().length>0?e:null};chrome.declarativeNetRequest?chrome.identity.getProfileUserInfo({accountStatus:"ANY"},function(o){e(t(o.email))}):chrome.identity.getProfileUserInfo(function(o){e(t(o.email))})}):Promise.resolve(null)}async function Ke(){return new Promise((e,t)=>{chrome.enterprise&&chrome.enterprise.deviceAttributes?chrome.enterprise.deviceAttributes.getDirectoryDeviceId(function(t){console.log("Start with requested directory device ID="+t),e(t)}):e(null)})}async function et(){return new Promise((e,t)=>{chrome.enterprise&&chrome.enterprise.deviceAttributes?chrome.enterprise.deviceAttributes.getDeviceSerialNumber(function(t){e(t)}):e(null)})}function tt(){return new Promise(e=>{chrome.alarms.clearAll(t=>{t?console.log("All alarms cleared"):(console.log("Alarms not cleared"),chrome.runtime.lastError&&console.log("Alarms clear error: "+chrome.runtime.lastError.message)),e()})})}async function ot(e,t){try{await nt(e,t)}catch(o){const n="Could not establish connection. Receiving end does not exist";if(-1===o.indexOf(n))throw o;await rt(e),await nt(e,t)}}function nt(e,t){return new Promise((o,n)=>{chrome.tabs.sendMessage(e,t,async function(e){chrome.runtime.lastError?n(chrome.runtime.lastError.message):o()})})}function rt(e){return new Promise((t,o)=>{chrome.tabs.executeScript(e,{file:"teacherTools.js",allFrames:!1,runAt:"document_start"},function(e){chrome.runtime.lastError?(console.log("Failed to inject scripts"),o(chrome.runtime.lastError.message)):t()})})}function it(e,t){return"number"!=typeof e?Promise.resolve():new Promise((o,n)=>{chrome.tabs.update(e,t,function(){chrome.runtime.lastError?n(chrome.runtime.lastError.message):o()})})}function at(){return new Promise((e,t)=>{chrome.windows.create({state:"fullscreen",type:"popup",focused:!0,url:"blocking/block.html"},function(o){chrome.runtime.lastError?t(chrome.runtime.lastError.message):e(o.id)})})}function ct(e){return new Promise((t,o)=>{chrome.windows.remove(e,function(){chrome.runtime.lastError?o(chrome.runtime.lastError.message):t()})})}async function lt(){return new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{const o=t.coords,n={latitude:o.latitude,longitude:o.longitude,accuracy:o.accuracy};console.log("Lat: "+o.latitude.toFixed(4)+" Lon: "+o.longitude.toFixed(4)),e(n)},t=>{console.log("Error: "+t.code+" "+t.message);const o={error:t.message};e(o)},{maximumAge:6e5,timeout:2e4})})}async function dt(e){return new Promise(t=>{chrome.alarms.get(e,e=>{t(e)})})}async function ut(e){return new Promise(t=>{chrome.alarms.clear(e,o=>{console.log("Alarm '"+e+(o?"' was cleared":"' was not cleared")),t()})})}class ht{constructor(t){this.items=t,this._defaultBlockMessage="Your device is blocked",this.directoryDeviceId=null,this._pingCount=0,this.isLoggedIn=!1,this.announce=null,this.sessionId=null,this.studentId=null,this.studentName=null,this.canRaiseHand=!1,this.isHandRaised=!1,this.tabListenersAdded=!1,this.chatMessages=[],this.hasUnreadChatMessages=!1,this.forceOpenChat=!1,this.canStartChat=!1,this.playChatAlert=!1,this.closeTabsTimeout=null,this.lockedToCourseWorkResources=!1,this.canvasAssignmentIds=[],this.maxOpenTabs=0,this.activeTab=null,this.userEmail=null,this.teacherId=null,this.teacherName=null,this.conferenceUrl=null,this.conferenceTabId=null,this.blockWindowId=0,this.maximizeFocusedWindow=!1,this.loginErrorReason=null,this.shareScreenHandler=null,this.capturedScreen=null,t[ne]||(this.items[ne]=e),t[oe]||(this.items[oe]=this._defaultBlockMessage),t[V]||(this.items[V]=Me?ce:le),t[ee]||(this.items[ee]=0),t[K]||(this.items[K]=!1),t[Z]||(this.items[Z]=!1),t[G]||(this.items[G]=!1),t[re]||(this.items[re]=new Date("01 Jan 1970 00:00:00 GMT").getTime())}get serverUrl(){return this.items[ne]}saveServerUrl(e){return this.store(ne,e)}get orgBlocklist(){return this.items[j]}async saveOrgBlocklist(e){await this.store(j,e),await this.store(ae,null)}get blockingPlanUrls(){return this.items[X]}get blockingPlanName(){return this.items[Q]}get blockingPlanType(){return this.items[Y]}async saveBlockingPlan(e,t,o){await this.store(X,e),await this.store(Q,t),await this.store(Y,o)}get blockedModeType(){return this.items[V]}saveBlockedModeType(e){return this.store(V,e)}get blockedText(){return this.items[oe]?this.items[oe]:this._defaultBlockMessage}get deviceName(){return this.items[$]}saveDeviceName(e){return this.store($,e)}get deviceUdid(){return this.items[se]}saveDeviceUdid(e){return this.store(se,e)}get isChromeBook(){return this.items[G]}saveIsChromeBook(e){return this.store(G,e)}get isChatActive(){return this.chatMessages.length>0}get isClassSessionActive(){return null!=this.sessionId}get isContactAdminAllowed(){return this.items[Z]}get isScreenLocked(){return this.items[V]===ce}get isScreenCaptureAllowed(){return this.items[K]}get isSiteLocked(){return!!this.items[ae]}get notificationInterval(){return this.items[ee]}get orgName(){return this.items[te]}get pingCount(){return this._pingCount++}get updateCheckDate(){return new Date(parseInt(this.items[re]))}async saveUpdateCheckDate(e){return this.store(re,e.getTime())}get whitelist(){return this.items[ae]?this.items[ae]:this.items[Y]===de?this.items[X]:null}async saveWhitelist(e){await this.store(ae,e)}async clearWhitelist(){this.lockedToCourseWorkResources=!1,await this.store(ae,null)}async saveBlockedInfo(e,t,o,n,s){let r={};e?(r[oe]=e,this.items[oe]=e):(r[oe]=this._defaultBlockMessage,this.items[oe]=this._defaultBlockMessage),t&&(r[V]=t,this.items[V]=t);let i="Stored screen block modeType: "+t+", message: "+e;return void 0!==n&&(r[K]=n,this.items[K]=n,i+=", capture screen: "+n),void 0!==s&&(r[Z]=s,this.items[Z]=s,i+=", allow contact admin: "+s),i+=", notification interval: ",void 0!==n&&o!==ke&&(r[ee]=o,this.items[ee]=o,i+=o),console.log(i),this.bulkStore(r)}async saveDeviceInfo(e,t,o,n,s,r,i){let a={};return a[te]=e,this.items[te]=e,a[$]=t,this.items[$]=t,a[V]=o,this.items[V]=o,a[oe]=n,this.items[oe]=n,a[ee]=s,this.items[ee]=s,a[Z]=r,this.items[Z]=r,a[K]=i,this.items[K]=i,this.bulkStore(a)}store(e,t){return t?(this.items[e]=t,new Promise(o=>{chrome.storage.local.set({[e]:t},function(){chrome.runtime.lastError?console.log("Failed to save object "+JSON.stringify(t)+" for key '"+e+"'. Error is: "+chrome.runtime.lastError.message):console.log("Stored "+JSON.stringify(t)+" for key: "+e),o()})})):(delete this.items[e],new Promise(t=>{chrome.storage.local.remove([e],function(){chrome.runtime.lastError?console.log("Failed to remove key '"+e+"'. Error is: "+chrome.runtime.lastError.message):console.log("Key '"+e+"' removed"),t()})}))}bulkStore(e){return new Promise(t=>{chrome.storage.local.set(e,function(){chrome.runtime.lastError?console.log("Failed to bulk save '"+JSON.stringify(e)+"'. Error is: "+chrome.runtime.lastError.message):console.log("Items "+JSON.stringify(e)+" saved"),t()})})}bulkDelete(e){return new Promise(t=>{chrome.storage.local.remove(e,function(){chrome.runtime.lastError?console.log("Failed to remove keys "+e+" Error is: "+chrome.runtime.lastError.message):console.log("Keys "+e+" removed"),t()})})}}const st=async function(){if(chrome.alarms.clearAll(),"function"==typeof co&&co(),Pe?((Re=new Dt).noActiveClassIcon(),Le=await Ye()):Le=new ht({}),Ne=new gt(Le.serverUrl),Le.userEmail=await Ze(),Me&&(requestBlockScreen(Le.blockedText,Le.blockedModeType,Le.notificationInterval,Le.isScreenCaptureAllowed,Le.isContactAdminAllowed),updateVersion()),Pe){const e=await $e();console.log("INIT URL STORAGE WITH URLS="+JSON.stringify(e)),Ro=new Ot(e)}await mt(),await It()};async function mt(){const directoryDeviceId=await Ke();directoryDeviceId?(Le.directoryDeviceId=directoryDeviceId,await Le.saveIsChromeBook(!0)):"function"==typeof substituteDeviceId&&substituteDeviceId()}const stp=function(){console.log("Stopping the app"),chrome.alarms.clearAll()};chrome.runtime.onSuspend.addListener(function(){console.log("App suspended")});class gt{constructor(e){this.url=e,console.log("Router initialized for "+this.url),this.queue=[],this.isSending=!1}static getAck(e){if(e){if(e.requestType===b)throw F;return{seq:e.seq,response:e.requestType}}return{}}updateUrl(e){this.url=e,console.log("Router url updated="+this.url)}async sendCommand(e){return Object.assign(e,{version:t,udid:Le.deviceUdid,command:"ack"}),this.queue.push(e),await this.processQueue()}cleanSent(){this.queue=this.queue.filter(e=>!e.sent)}cleanQueue(){this.queue.splice(0,this.queue.length)}async processQueue(){let e=!1;if(this.isSending)return!0;this.cleanSent(),this.isSending=!0;try{for(const e of this.queue)console.log("Sending command="+JSON.stringify(e)),await this.send(e,n),console.info("Command "+JSON.stringify(e)+" sent successfully"),e.sent=!0;e=!0}catch(t){console.log("Failed to send command. Error="+t),e=!1}finally{this.isSending=!1,this.cleanSent()}return e}async readCommands(e){return Object.assign(e,{version:t,udid:Le.deviceUdid,command:"ack"}),this.queue.length>0&&await this.processQueue(),console.log("Sending ack="+JSON.stringify(e)),await this.send(e,o)}async send(e,t){return new Promise((o,n)=>{const i=new XMLHttpRequest;i.timeout=ye,i.upload.addEventListener("error",function(e){n("XHR: Error in request upload")}),i.ontimeout=function(){n("XHR: Request timeout")},i.open("POST",this.url+t),i.setRequestHeader(be,e.udid),i.setRequestHeader("Content-Type","application/json; charset=UTF-8"),i.onreadystatechange=async function(){if(this.readyState===XMLHttpRequest.DONE)switch(this.status){case s:if(this.responseText&&this.responseText.length>0)try{const e=JSON.parse(this.responseText);o(e)}catch(e){let t=this.responseText.length>200?this.responseText.substr(0,200)+"...":this.responseText;n("XHR: Received incorrect response="+t)}else o();break;case 0:n("Status 0");break;case r:n(z);break;default:n("XHR: Server responded with http status="+this.status)}},i.send(JSON.stringify(e))})}}async function ft(e){const t=Ee[e.requestType];if(void 0!==t)return t(e);console.log("Got unknown message: "+e.requestType)}async function pt(e){if(!e)return Promise.resolve();console.log("Process server commands: "+JSON.stringify(e));let t=e.commands;return t&&t.length>0?t.reduce((e,t)=>e.then(ft(t)),Promise.resolve()):ft(e)}async function wt(e){let t=e.commands;return t&&t.length>0?{responses:t.map(e=>gt.getAck(e))}:e.requestType?{responses:[gt.getAck(e)]}:{responses:[]}}async function vt(){console.log("Long polling started"),Pe&&chrome.alarms.create(fe,{periodInMinutes:1});let e=0,t=null,o=!0;for(;o;)try{t||(t=gt.getAck());const n=await Ne.readCommands(t);n?(t=await wt(n).catch(()=>{o=!1}),pt(n).catch(e=>{qt(e,F)?o=!1:console.log("Failed to process action for one of responses:"+n+" error: "+e)})):t=null}catch(t){Le.isLoggedIn?t===z?(o=!1,await cn()):((e+=1)>=3&&(chrome.alarms.create(me,{delayInMinutes:1}),console.log("Schedule server polling restart due to error="+t),o=!1),console.log("Error #"+e+" while polling="+t)):(chrome.alarms.create(he,{delayInMinutes:1}),console.log("Not logged in. Repeat login in 1 minute. Error: "+t),o=!1)}console.log("Long polling stopped"),chrome.alarms.clear(fe)}function bt(e){switch(console.log("Fired alarm "+e.name),e.name){case we:Le.isScreenLocked||requestBlockScreen(Le.blockedText,Le.blockedModeType,ke,Le.isScreenCaptureAllowed,Le.isContactAdminAllowed);break;case he:It();break;case pe:void 0!==Cn&&yt();break;case fe:kt();break;case ge:chrome.runtime.reload();break;case me:chrome.alarms.clear(me),vt();break;case ve:chrome.alarms.clear(ve),Wo.connect(Gt),Wo.isConnected&&Wo.handshake();break;default:console.log("Cannot process alarm")}}function yt(){const e=new XMLHttpRequest,t="Ping "+Le.pingCount,o=Le.serverUrl+"/agent/chrome/debug";e.open("POST",o),e.setRequestHeader(be,Le.deviceUdid),e.setRequestHeader("Content-Type","application/json; charset=UTF-8");const n={udid:Le.deviceUdid,logString:t,logNum:Cn.logCount,logSource:"extension"};e.send(JSON.stringify(n)),Cn.logCount+=1}async function kt(){if(!Ro.hasUrls())return;if(kt.isSending)return;kt.isSending=!0;const e=Le.sessionId;if(e){const t=await De({active:!0,lastFocusedWindow:!0});let o,n=0;if(t.length>0){const e=t[0];void 0!==e.id&&e.id!==chrome.tabs.TAB_ID_NONE&&(n=e.id);const s=e.url;void 0!==s&&(o=Eo(s))}n>0&&o&&Ro.saveUrl(e,new xt(o,t[0].title))}const t={udid:Le.deviceUdid,urls:Ro.getUrls(),timestamp:Date.now()};try{await Ct(t),console.log("Urls sent successfully"),Ro.purge()}catch(e){console.log("Error while sending urls: "+e)}finally{kt.isSending=!1}}async function Ct(e){return new Promise((t,o)=>{const n=new XMLHttpRequest,s="Failed to send urls to the server: ";n.timeout=ye,n.upload.addEventListener("error",function(e){o(s)}),n.ontimeout=function(){o(s+"Request timeout")},n.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&(200===this.status?t():(0===this.status||this.status>=400)&&o("Failed to send urls to the server: "+this.status))};const r=Le.serverUrl+"/agent/chrome/url";n.open("POST",r),n.setRequestHeader(be,Le.deviceUdid),n.setRequestHeader("Content-Type","application/json; charset=UTF-8"),n.send(JSON.stringify(e))})}async function It(e){console.log("Initiate login at "+new Date),await tt(),Ne.cleanQueue();try{if(await pt(await _t()),await pt(await Et()),!Le.isChromeBook){if(await ko())return void console.log("Windows agent is present. Terminating login")}if(!await Ut())return console.log("Failed to login. Repeat in 1 minute"),void chrome.alarms.create(he,{periodInMinutes:1});Pe&&(chrome.browserAction.onClicked.removeListener(It),chrome.runtime.onMessage.removeListener(go)),void 0!==Cn&&(Cn.logCount=0),Le.pingCount=0,Le.loginErrorReason=null,vt()}catch(t){qt(t,F)?(console.log("Failed to authenticate: "+t),console.log("Logout and login again to connect"),e&&Le.loginErrorReason&&Le.loginErrorReason!==Oe&&await Tt()):qt(t,z)?(console.log("Extension upgrade required"),await cn()):(console.log("Failed to login: "+t),chrome.alarms.create(he,{periodInMinutes:1}))}}function St(){It(!0)}async function Tt(){const e=chrome.runtime.getURL("notfound.html");try{await Ve({url:e})}catch(e){console.log("Cannot open not found page due to error: "+e)}}function _t(){const n=Le.serverUrl===e,s=Le.directoryDeviceId;if(console.log("Request server url="+n+" config.serverUrl="+Le.serverUrl+" udid="+s),!n)return Promise.resolve();const r={command:c,udid:s,kiosk:Me,userEmail:Me?"kiosk":Le.userEmail,version:t,userAgent:navigator.userAgent};return console.log("Get org url message="+JSON.stringify(r)),Ne.send(r,o)}async function Et(){if(Le.deviceUdid)return Promise.resolve();const e={command:a,userEmail:Le.userEmail,kiosk:Me,version:t,userAgent:navigator.userAgent};return Le.directoryDeviceId?e.udid=Le.directoryDeviceId:e.byod=!0,console.log("Send AUTHENTICATE="+JSON.stringify(e)),Ne.send(e,o)}async function Ut(){return await Ne.send({response:u,kiosk:Me,userEmail:Me?"kiosk":Le.userEmail,userAgent:navigator.userAgent,version:t,udid:Le.deviceUdid,command:"ack"},n),!0}function At(e,t){Ne.sendCommand({response:i,appList:e,userId:t})}function sm(e){const t={response:m,text:e};Ne.sendCommand(t)}async function Lt(e,t){const o=void 0!==t.maxWidth?t.maxWidth:0,n=void 0!==t.maxHeight?t.maxHeight:0,s=await Mt(e,o,n);let r=Nt(t.url);void 0!==t.tabUrl&&(r+="&tabUrl="+encodeURIComponent(t.tabUrl)),void 0!==t.tabTitle&&(r+="&tabTitle="+encodeURIComponent(t.tabTitle)),Rt(r,s)}async function Rt(e,t){return new Promise(o=>{let n=new XMLHttpRequest;n.timeout=ye,n.upload.addEventListener("error",function(t){console.log("Failed to upload screenshot to url="+e)}),n.ontimeout=function(){console.log("Timeout while uploading screenshot to url="+e)},n.open("POST",e),n.setRequestHeader(be,Le.deviceUdid),n.setRequestHeader("Content-Type","image/jpg"),n.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&(this.status>=200&&this.status<400?console.log("Screenshot send complete to url="+e):console.log("Status="+this.status+". Failed to upload screenshot to url="+e),o(204!==this.status))},n.send(t)})}function Nt(e){let t=Le.serverUrl+e;return-1!==t.indexOf("uid=")?t+="&udid="+Le.deviceUdid:t+="?udid="+Le.deviceUdid,Le.userEmail&&(t+="&userEmail="+encodeURIComponent(Le.userEmail)),t}function Mt(e,t,o){return new Promise((n,s)=>{if(0===t&&0===o)console.log("Image will not be resized"),n(e);else{let s=document.createElement("img");s.onload=function(r){const i=s.width,a=s.height,c=Math.min(t/i,1),l=Math.min(o/a,1);let d;1===(d=0!==c&&0!==l?c<l?c:l:0!==c?c:l)&&(console.log("Image will not be resized"),n(e)),n(Pt(s,d))},s.src=e}}).then(e=>fetch(e)).then(e=>e.blob())}function Pt(e,t){const o=Math.ceil(Math.log(1/t)/Math.log(2));let n=document.createElement("canvas"),s=n.getContext("2d");s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";let r={width:e.width,height:e.height};for(let i=1;i<=o;i++){const o=t+(1-t)/(2*i),a=Math.floor(e.width*o),c=Math.floor(e.height*o);1===i?(n.width=a,n.height=c,s.drawImage(e,0,0,a,c)):s.drawImage(n,0,0,r.width,r.height,0,0,a,c),r={width:a,height:c}}let i=document.createElement("canvas");i.width=Math.floor(e.width*t),i.height=Math.floor(e.height*t);let a=i.getContext("2d");return a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(n,0,0,r.width,r.height,0,0,i.width,i.height),i.toDataURL("image/jpeg")}function qt(e,t){return"string"==typeof e&&e.toLowerCase().includes(t)}chrome.alarms.onAlarm.addListener(bt);class xt{constructor(e,t,o){this.domain=e,this.tabTitle=t,this.isBlocked=!!o,this.timestamp=Date.now()}}class Ot{constructor(e){this.urls="object"==typeof e?e:{},this.lastVisitedUrl=null}saveUrl(e,t){e||(e="blocked");let o=this.urls[e];if(o||(o=[],this.urls[e]=o),!this.isLast(t))if(this.lastVisitedUrl=t,t.domain.length<1e3&&(!t.tabTitle||t.tabTitle.length<255))o.push(t);else{const e=new xt(t.domain.substr(0,1e3),t.tabTitle?t.tabTitle.substr(0,255):null,t.isBlocked);o.push(e)}chrome.storage.local.set({[ie]:this.urls},()=>{chrome.runtime.lastError&&console.log("Failed to save urls to local storage. Error is: "+chrome.runtime.lastError.message)})}isLast(e){return this.lastVisitedUrl instanceof xt&&this.lastVisitedUrl.domain===e.domain}hasUrls(){return Object.keys(this.urls).length>0}getUrls(){return this.urls}purge(){this.urls={},this.lastVisitedUrl=null,chrome.storage.local.remove(ie,()=>{chrome.runtime.lastError?console.log("Failed to clear urls from local storage: "+chrome.runtime.lastError.message):$e().then(e=>{void 0!==e?console.log("Failed to clear urls from local storage"):console.log("Urls cleared from local storage")})})}}chrome.runtime.onUpdateAvailable.addListener(function(e){Pe&&(console.log("Extension update available, will reload. Current version="+t),chrome.runtime.reload())});class Dt{constructor(){this.active=!1,this.sharesScreen=!1}isActive(){return this.active}activeClassIcon(){chrome.browserAction.setIcon({path:"logo16.png"},function(){Re.active=!0})}noActiveClassIcon(){chrome.browserAction.setIcon({path:"logo16mono.png"},function(){Re.active=!1})}raiseHandIcon(){chrome.browserAction.setIcon({path:"hand.png"})}shareScreenIcon(){chrome.browserAction.setIcon({path:"logo16share.png"},function(){Re.sharesScreen=!0})}noShareScreenIcon(){let e=this.active?"logo16.png":"logo16mono.png";chrome.browserAction.setIcon({path:e},function(){Re.sharesScreen=!1})}clearRaiseHandIcon(){this.sharesScreen?this.shareScreenIcon():this.active?this.activeClassIcon():this.noActiveClassIcon()}static markNotAuthorized(){chrome.browserAction.setBadgeText({text:"!"}),chrome.browserAction.setBadgeBackgroundColor({color:"#F00"})}static clearBadge(){chrome.browserAction.setBadgeText({text:""})}}function Ht(){const e=Le.isClassSessionActive;!Le.tabListenersAdded&&e?(chrome.tabs.onActivated.addListener(Yt),chrome.tabs.onCreated.addListener($t),chrome.tabs.onUpdated.addListener(Zt),Le.tabListenersAdded=!0):Le.tabListenersAdded&&!e&&(chrome.tabs.onActivated.removeListener(Yt),chrome.tabs.onCreated.removeListener($t),chrome.tabs.onUpdated.removeListener(Zt),Le.tabListenersAdded=!1)}function Wt(e){e>0?(chrome.idle.setDetectionInterval(60*e),chrome.idle.onStateChanged.addListener(Bt)):chrome.idle.onStateChanged.removeListener(Bt)}function Bt(e){const t={response:d,isIdle:"active"!==e};Ne.sendCommand(t)}async function Ft(e){const t=await De({});for(const o of t)try{await Kt(o,"onApply",e),await it(o.id,{muted:Le.isScreenLocked})}catch(e){console.log("Error updating lock status: "+e)}}function Jt(){if(Le.isClassSessionActive){const e=(Le.isScreenLocked||Le.maximizeFocusedWindow)&&!chrome.windows.onFocusChanged.hasListener(zt),t=Le.maximizeFocusedWindow&&!chrome.windows.onBoundsChanged.hasListener(Vt),o=Le.isScreenLocked&&!chrome.windows.onRemoved.hasListener(jt);e&&chrome.windows.onFocusChanged.addListener(zt),t&&(chrome.windows.onBoundsChanged.addListener(Vt),chrome.windows.onCreated.addListener(Vt)),o&&chrome.windows.onRemoved.addListener(jt)}else chrome.windows.onFocusChanged.removeListener(zt),chrome.windows.onRemoved.removeListener(jt),chrome.windows.onBoundsChanged.removeListener(Vt),chrome.windows.onCreated.removeListener(Vt)}async function zt(e){if(!Le.maximizeFocusedWindow||Le.isScreenLocked||"number"!=typeof e||e===chrome.windows.WINDOW_ID_NONE||e===Le.blockWindowId){if(Le.isScreenLocked&&Le.isChromeBook){if(!Le.blockWindowId){const e=await Be();if(!e)return;Le.blockWindowId=e.id}void 0!==e&&("number"!=typeof e||e!==chrome.windows.WINDOW_ID_NONE&&e===Le.blockWindowId)||await Je(Le.blockWindowId)}}else await ze(e,{state:"maximized"})}async function jt(e){Le.isScreenLocked&&Le.blockWindowId===e&&setTimeout(async()=>{try{Le.blockWindowId=await at(),await Je(Le.blockWindowId)}catch(e){console.log("Cannot make window fullscreen: "+e)}},1e3)}async function Vt(e){if("normal"===e.type&&e.id!==Le.blockWindowId&&"fullscreen"!==e.state)try{await ze(e.id,{state:"maximized"})}catch(e){console.log("Cannot maximize window: "+e)}}function Gt(e){const t=e.action;switch(t){case No:const o={response:A,app:e.app,userId:e.userId,isClosed:!0};e.isClosed||(o.isClosed=!1,o.error=e.error),Ne.sendCommand(o);break;case Po:void 0!==Cn&&Wo.updateLogging(Cn.logEnabled);const n=e.version;console.log("Native agent communication established. Version="+n),Ne.sendCommand({response:f,agentVersion:n}),co(Se,n);break;case Mo:At(e.appList,e.userId);break;default:console.log("Native agent sent unknown command="+t)}}async function Xt(e){const t=await De({});for(const o of t)try{await eo(o,"onApply",e)}catch(e){console.log("Catched update chat state error for tab="+o.id+" '"+o.url+"': "+e)}}async function Qt(e){if(Le.maxOpenTabs>0){let t=await De({});if(Qt.bypass)return Qt.bypass=!1,Promise.resolve(!0);if(t.length>Le.maxOpenTabs){if(void 0===e.id)return console.log("Cannot close tab, no tab.id"),Promise.resolve(!1);Ge(e.id)}}return Promise.resolve(!0)}function Yt(e){const t=e.tabId;if(null!=Le.activeTabId){if(Le.activeTabId!==t&&Le.isChatActive){const e={command:"chatStatus",chat:!0,forceCloseChat:!0};if(ot(Le.activeTabId,e).then(()=>{console.log("Command to close chat in tabId="+Le.activeTabId+" sent. New active tabId="+t),Le.activeTabId=t}).catch(e=>{console.log("Error="+e+". Command to close chat in tabId="+Le.activeTabId+" NOT sent. New active tabId="+t)}),Le.hasUnreadChatMessages&&Le.forceOpenChat){ot(t,{command:"chatStatus",chat:!0,forceOpenChat:!0}).then(()=>{console.log("Command to open chat in tabId="+t+" sent.")}).catch(e=>{console.log("Error= "+e+". Command to open chat in tabId="+t+" NOT sent.")})}}}else Le.activeTabId=t}async function $t(e){if(!(null!==Le.conferenceUrl&&"loading"===e.status||e.url&&Le.conferenceUrl===e.url))if(await Qt(e)){if(Le.isChatActive)return eo(e,"onCreate")}else console.log("Catched on tab create listener error: Tabs limit exceeded")}async function Zt(e,t,o){if("complete"===t.status){if(null!==Le.conferenceUrl&&(void 0===o.url||Le.conferenceUrl===o.url))return;const e=await Qt(o);try{e&&Le.isChatActive&&await eo(o,"onUpdate"),e&&Le.isScreenLocked&&await Kt(o,"onUpdate")}catch(e){console.log("Catched on tab update listener error: "+JSON.stringify(e))}}}async function Kt(e,t,o){if(void 0!==e.status&&void 0!==e.url&&"number"==typeof e.id){if(!Uo(e.url,["https?:\\/\\/chrome\\.google\\.com\\/webstore\\/?.*?"],!1)&&(Le.isScreenLocked||Le.whitelist||null!==Le.announce))return void Ge(e.id);let n=null;Le.isScreenLocked?n=Le.blockedText:Le.whitelist&&!Uo(e.url,Le.whitelist,!0)?n=Le.isSiteLocked?"This site is not available during site lock":"This site is currently unavailable due to an active blocking plan":Le.blockingPlanType===ue&&Le.blockingPlanUrls&&!Uo(e.url,Le.blockingPlanUrls,!1)&&(n="This site is currently unavailable due to an active blocking plan");const s=null!==Le.closeTabsTimeout&&!o||null,r={command:"lockStatus",announce:Le.announce,announceTitle:"Announcement from"+(Le.teacherName?": "+Le.teacherName:" your teacher"),lock:n,tabsCloseWarning:s,messageType:t};try{await ot(e.id,r)}catch(t){-1!==t.indexOf("chrome://")?Ge(e.id):console.log("Lock not sent to tab '"+e.id+" {status:"+e.status+", discarded:"+e.discarded+"} "+e.title+"'. Error: "+t)}}}async function eo(e,t,o){return void 0===e.status||void 0===e.url?Promise.resolve():new Promise(async(n,s)=>{if("number"==typeof e.id){const r={command:"chatStatus",messageType:t};Le.isChatActive?(r.chat=!0,o?r.chatMessage=o:Le.hasUnreadChatMessages&&(r.chatMessage=Le.chatMessages[Le.chatMessages.length-1]),r.chatMessage&&e.highlighted&&Le.forceOpenChat&&(r.forceOpenChat=!0)):r.chat=!1,console.log("Send chat status message="+JSON.stringify(r)+" tabId="+e.id+" '"+e.url+"'");try{await ot(e.id,r),n()}catch(e){s("Failed to send chat status:"+e)}}})}function to(e){let t=Promise.resolve();return e.forEach(e=>{t=t.then(()=>Ve({url:e,active:!0}))}),t.catch(e=>{console.log("Error while open sites: "+e)}),t}async function oo(e,t){if(!e||0===e.length)return Promise.resolve();const o=e.map(e=>e.id);return t&&(Qt.bypass=!0,await Ve({})),Ge(o)}async function no(e){let t=await De({});const o={command:"tabCloseWarning",delaySeconds:e};for(const e of t){if(void 0===e.status||void 0===e.url)return;if("number"==typeof e.id)try{await ot(e.id,o)}catch(e){console.log("Error while apply tabs close warning: "+e)}}}async function so(e,t,o=!1){try{let n;if(await Ft(),t&&(n=await De({})),!o){const t=await He();t&&0!==t.length?await to(e):await Fe(e)}t&&await oo(n,o)}catch(e){console.log("Error while site lock: "+JSON.stringify(e))}}function ro(e){const t=/\/courses\/\d+\/assignments\/(\d+)/,o=[];for(const n of e){const e=n.match(t);e&&e.length>1&&o.push(e[1])}return o}async function io(){const e=Le.serverUrl+"/screenshare*",t=await De({url:e});for(const e of t)e.id&&await Ge(e.id)}function ao(e,t){Re||(Re=new Dt),e?(Re.activeClassIcon(),co(Se)):(Re.noActiveClassIcon(),co())}function co(e,o){const n={};if(void 0!==e){let s=e+"\n";void 0!==o&&(s+="Windows agent "+o+"\n"),n.title=s+t}else n.title=t;chrome.browserAction.setTitle(n)}function lo(e){const t=e?"popup.html":"";chrome.browserAction.setPopup({popup:t},()=>{console.log("Popup set to "+(e?t:"none"))})}function uo(){const e=ho(!0);Le.announce=null,Le.teacherId=null,Ht(),Ft().then(Ne.sendCommand(e))}function ho(e){return{response:D,isConfirmed:e,teacherId:Le.teacherId}}function mo(e){e?(chrome.runtime.onMessage.addListener(go),console.log("MESSAGE LISTENER ADDED")):(chrome.runtime.onMessage.removeListener(go),console.log("MESSAGE LISTENER REMOVED"))}function go(e,t,o){switch(console.log("Got message from tab="+JSON.stringify(t.tab)+" Message="+JSON.stringify(e)),e.action){case"popup":return wo(e,t,o);case"notfound":return vo(e,t,o),!0;case"teacherMessage":uo();break;case"clearTabsCloseWarning":Ht(),Ft(!0),console.log("Tabs close warning cleared by student"),o();break;case"respondToShareScreen":fo(e);break;case"chat":return bo(e,t,o);case"resizeLocked":zt();break;case"getLockText":Le.isScreenLocked?o(Le.blockedText):o(null);break;case"call":o({token:Le.conferenceToken,studentName:Le.studentName});break;case"suspicious":o(null),"about:blank"===t.tab.url&&(console.log("Closing suspicious tab: "+JSON.stringify(t.tab)),Ge(t.tab.id));break;default:console.log("Received incorrect message in pageMessageListener="+JSON.stringify(e))}}function fo(e){Ft();const t=e.isConfirmed,o={response:x,userId:e.userId,lock:e.lock,isConfirmed:t};if(Ne.sendCommand(o),t){const t=e.deviceId,o=Le.serverUrl+"/agent/sharescreen/upload?did="+t;Le.shareScreenHandler=setInterval(po,4e3,o,1024),Re.shareScreenIcon()}}async function po(e,t){let o=!1;if(Wo.isConnected&&(o=Wo.requestScreenshot(e,t,t)),o)console.log("Screenshot requested from native agent");else{try{Le.capturedScreen=await Qe()}catch(e){return void console.log("Cannot capture visible tab: "+e)}const o=await Mt(Le.capturedScreen,t,t);await Rt(e,o)||Xo()}}function wo(e,t,o){let n=!1;switch(e.popup){case"hello":return De({currentWindow:!0,active:!0}).then(e=>{if(e&&e.length>0){const t=e[0].url;t&&!t.toLowerCase().includes("newtab")&&(n=Le.canStartChat||Le.isChatActive)}}).catch(e=>{console.log("Error responding to popup="+e)}).finally(()=>{o({raiseHandEnabled:Le.canRaiseHand,isHandRaised:Le.isHandRaised,isSharingScreen:null!==Le.shareScreenHandler,canStartChat:n})}),!0;case"handRaiseClick":Le.isHandRaised=!Le.isHandRaised,o({raiseHandEnabled:Le.canRaiseHand,isHandRaised:Le.isHandRaised}),Le.isHandRaised?Re.raiseHandIcon():Re.clearRaiseHandIcon(),Ne.sendCommand({response:l,isHandRaised:Le.isHandRaised});break;case"startChatClick":o(),De({currentWindow:!0,active:!0}).then(e=>{if(e&&e.length>0){const t={command:"chatStatus",chat:!0,forceOpenChat:!0};ot(e[0].id,t),console.log("Sent message to tabId="+e[0].id)}else console.log("Cannot open chat from popup - no active tab")})}}async function vo(e,t,o){const n={reason:Le.loginErrorReason},directoryDeviceId=await Ke();directoryDeviceId&&(n.directoryDeviceId=directoryDeviceId);const s=await et();s&&(n.serialNumber=s),o(n)}function bo(e,t,o){switch(e.command){case"getChatMessages":Le.hasUnreadChatMessages=!1,o({chatMessages:Le.chatMessages});break;case"sendMessage":o();const t={sessionId:Le.sessionId,text:e.text,response:T},n={date:(new Date).toUTCString(),isFromTeacher:!1,text:e.text};Le.chatMessages.push(n),Ne.sendCommand(t).catch(e=>{console.log("Chat message send failed: "+JSON.stringify(e))});break;default:o({chat:Le.isChatActive,unread:Le.hasUnreadChatMessages})}}function yo(e,t,o){chrome.notifications.clear(e,function(n){chrome.notifications.create(e,{title:t,iconUrl:"logo48.png",type:"basic",message:o})})}async function ko(){return new Promise(e=>{chrome.runtime.sendNativeMessage(xe,{action:Po},t=>{chrome.runtime.lastError&&(console.log("Error sending handshake to Windows agent V2: "+chrome.runtime.lastError.message),e(!1)),e(t&&"string"==typeof t.version)})})}function Co(e){if(!Le)return{cancel:!1};const t=e.url;if(Io(t))return{cancel:!1};let o=!0,n=chrome.runtime.getURL("blocking/block.html");if(!Le.whitelist||Le.lockedToCourseWorkResources&&Ao(e)){if(Le.orgBlocklist||Le.blockingPlanUrls){const e=!Le.orgBlocklist||Uo(t,Le.orgBlocklist,!1),s=!Le.blockingPlanUrls||Uo(t,Le.blockingPlanUrls,!1);(o=e&&s)||Ro.saveUrl(Le.sessionId,new xt(t,null,!0)),e?s||(n+="?t="+btoa(encodeURIComponent(Le.blockingPlanName))):n+="?t=o"}}else o=Uo(t,Le.whitelist,!0),n+=Le.isSiteLocked?"?t=w":"?t="+btoa(encodeURIComponent(Le.blockingPlanName));return o?{cancel:!1}:{redirectUrl:n}}function Io(t){if(-1!==t.indexOf("chrome-extension://"+chrome.runtime.id))return!0;if(-1!==t.indexOf("/_/chrome/newtab"))return!0;const o=t.match("^(.*[a-zA-Z]:\\/\\/)?([^\\/\\n]*)(\\/.*)?$");if(o&&o.length>1){const o=t.match("^(.*[a-zA-Z]:\\/\\/)?([^\\/\\n]*)(\\/.*)?$")[2],n=[e.replace("https://",""),"deviceconsole.securly.com","techpilotlabs.com"];for(const e of n)if(o.match(e))return!0}return!1}function So(e){if(!Le||!Le.lockedToCourseWorkResources)return{cancel:!1};if(302===e.statusCode){const t=e.responseHeaders.find(e=>"location"===e.name.toLowerCase());t&&Uo(e.url,Le.whitelist,!0)&&!Le.whitelist.some(e=>t.value===e)&&(Le.whitelist.push(t.value),Le.saveWhitelist(Le.whitelist))}return{cancel:!1}}function To(e){const t=Le.sessionId;if(!t)return;const o=Eo(e.url);o&&-1!==o.indexOf("chrome-extension")||o&&(-1!==e.tabId?_o(e.tabId).then(e=>{Ro.saveUrl(t,new xt(o,e))}):Ro.saveUrl(t,new xt(o,null)))}async function _o(e,t=!0){try{const o=await je(e);if(o.title)return o.title;if(t)return await new Promise(e=>setTimeout(e,1e3)),_o(e,!1)}catch(e){}return null}function Eo(e){return e.match(/^([a-zA-Z]*:\/\/)?([wW]{3}[0-9]?\.)?([^\/\?]*)(\/|\?)?.*$/)[3]}function Uo(e,t,o){if(Le.lockedToCourseWorkResources)for(const t of Le.canvasAssignmentIds)if(e.includes("assignment_id="+t))return o;e.includes("youtube.com")||(e=e.split("?")[0]);for(const n of t)if(e.match(n))return o;return!o}function Ao(e){const t=e.url?Eo(e.url):null;for(const e of Ue)if(t&&t.includes(e))return!0;if("string"==typeof e.initiator){const t=e.initiator;for(const e of Ae)if(t.includes(e))return!0}return!1}async function Lo(){if(navigator.onLine){if(!Lo.connecting){Lo.connecting=!0,console.log("Connection restored"),await dt(me)&&(console.log("Restarting polling after connection restored"),await ut(me),vt())}}else Lo.connecting=!1,console.log("Connection lost")}Qt.bypass=!1;var Ro=null;chrome.webRequest.onBeforeRequest.addListener(Co,{urls:["<all_urls>"],types:["main_frame"]},["blocking"]),chrome.webRequest.onHeadersReceived.addListener(So,{urls:["<all_urls>"],types:["main_frame"]},["blocking","responseHeaders"]),console.log("Extension log here"),navigator.connection.addEventListener("change",Lo);const No="closeApp",Mo="apps",Po="handshake",qo="logging",xo="screenshot",Oo="shutdown",Do="upgrade";class Ho{constructor(){this.onDisconnectListener=this.onDisconnectListener.bind(this),this.onMessageListener=this.onMessageListener.bind(this)}connect(e){this.listener=e,this.port=chrome.runtime.connectNative(qe),this.port.onMessage.addListener(this.onMessageListener),this.port.onDisconnect.addListener(this.onDisconnectListener)}onMessageListener(e){console.log("Native agent sent a message="+JSON.stringify(e)),this.listener(e)}onDisconnectListener(){chrome.runtime.lastError&&console.log("Native agent disconnected due to error="+JSON.stringify(chrome.runtime.lastError)),this.port=null,this.listener=null}get isConnected(){return null!=this.port}sendMessage(e){if(this.port)try{this.port.postMessage(e),console.log("Native agent received a message="+JSON.stringify(e))}catch(e){qt(e.message,J)?this.port=null:console.log("Native agent message sent error="+e.message)}return null!=this.port}closeApp(e,t){return this.sendMessage({action:No,app:e,userId:t})}handshake(){return this.sendMessage({action:Po,udid:Le.deviceUdid,server:Le.serverUrl})}requestScreenshot(e,t,o){const n={url:e,action:xo};return t&&(n.maxWidth=t),o&&(n.maxHeight=o),this.sendMessage(n)}updateLogging(e){return this.sendMessage({action:qo,isActive:e})}requestAppList(e){return this.sendMessage({action:Mo,userId:e})}shutdown(){return this.sendMessage({action:Oo})}requestUpgrade(e,t,o){const n={action:Do,version:e,url:t,sha:o};return this.sendMessage(n)}}var Wo=new Ho;async function Bo(e){const t=e.app,o=e.userId;Wo.isConnected&&Wo.closeApp(t,o)?console.log("'"+t+"' app close requested from native agent"):(console.log("Cannot close '"+t+"' app, native agent not connected"),Ne.sendCommand({response:e.requestType,app:t,isClosed:!1,error:"Native agent is not connected"}))}async function Fo(e){const t=e.tabId,o=e.requestType,n=e.userId;Ge(t).then(()=>{Ne.sendCommand({response:o,tabId:t,userId:n,isClosed:!0})})}async function Jo(e){const t=e.tabId;await Xe(t),Ne.sendCommand({response:e.requestType,tabId:t,userId:e.userId})}async function zo(e){Le.chatMessages.push(e.chatMessage),Le.hasUnreadChatMessages=!0,Ht();try{if(await Xt(e.chatMessage),Le.playChatAlert){const e=new Audio("https://deviceconsole.securly.com/sound/chat.wav");await e.play()}}catch(e){console.log("Failed to update chat status on incoming message")}}async function jo(e){const t=e.sessionId?e.sessionId:null,o=!!t,n=!!e.showNotifications,s=!!e.maximizeFocused,r=!!e.premium;if(Le.maximizeFocusedWindow=s,o&&Le.sessionId===t)console.log("Same session. Continue");else if(o||null!==Le.sessionId){if(o||await kt(),o&&r?(Wo.connect(Gt),Wo.isConnected&&Wo.handshake()):Wo.isConnected&&Wo.shutdown(),Le.shareScreenHandler&&Xo(),io(),await Go(t,e,Wo.isConnected),Le.conferenceUrl=null,n&&(o?yo(Ce,"Class session is active","Your device could be monitored and remotely managed by a teacher"):yo(Ce,"No active class session","Your device is not monitored and cannot be remotely managed by a teacher")),o&&await Qo(t),s){const e=await Be();if(e)try{await ze(e.id,{state:"maximized"})}catch(e){console.log("Cannot maximize window: "+e)}}Jt()}else console.log("Session already had been finished. Continue")}async function Vo(e){Le.canRaiseHand=!!e.allowHandRaise,Le.isHandRaised=!1,Le.canStartChat=!!e.canStartChat,Le.playChatAlert=!!e.playChatAlertToStudent}async function Go(e,t,o){const n=!!e;n?chrome.webRequest.onCompleted.hasListener(To)||chrome.webRequest.onCompleted.addListener(To,{urls:["<all_urls>"],types:["main_frame"]}):chrome.webRequest.onCompleted.removeListener(To),null!=Le.closeTabsTimeout&&(clearTimeout(Le.closeTabsTimeout),Le.closeTabsTimeout=null),Le.sessionId=e;const s=!!t.allowHandRaise,r=!!t.closeTabs,i=parseInt(t.closeTabsWaitSeconds),a="number"==typeof parseInt(t.maxOpenTabs)?parseInt(t.maxOpenTabs):0,c=t.chatMessages,l=!!t.forceOpenChat,d=!!t.canStartChat,u=!!t.playChatAlertToStudent,h=!!t.premium,m=t.idleTimeout;if(Le.canRaiseHand=s,Le.isHandRaised=!1,Le.announce=null,Le.hasUnreadChatMessages=!1,Le.chatMessages=c||[],Le.forceOpenChat=l,Le.canStartChat=d,Le.playChatAlert=u,Le.maxOpenTabs=a,ao(n,o),lo(h&&n),Ht(),mo(n),Wt(m),await Xt(),await Ft(),r)"number"==typeof i&&i>0?(await no(i),Le.closeTabsTimeout=setTimeout(async function(){console.log("Close tabs on session start after timeout"),await oo(await De({}),!Le.isChromeBook),Le.closeTabsTimeout=null},1e3*i)):(console.log("Close tabs on session start"),await oo(await De({}),!Le.isChromeBook));else if(a>0){const e=await De({});e.length>a&&await oo(e.slice(0,a),!Le.isChromeBook)}}function Xo(){clearInterval(Le.shareScreenHandler),Le.capturedScreen=null,Le.shareScreenHandler=null,Re.noShareScreenIcon(),yo(Ie,"Screen sharing ended","Your teacher has stopped sharing your screen")}async function Qo(e){const t=function(e,t){if(!e||!e[0]||!e[0].url)return;const o=e[0],n=Eo(o.url);n&&-1!==n.indexOf("chrome-extension")||Ro.saveUrl(t,new xt(n,o.title))},o=await De({lastFocusedWindow:!0,active:!0});if(o.length>0)t(o,e);else{t(await De({active:!0}),e)}}async function Yo(){Le.isHandRaised=!1,Re.clearRaiseHandIcon()}async function $o(e){const t=e.url,o=e.lockToSession;if(!t&&null!==Le.conferenceUrl)return await Le.clearWhitelist(),Ht(),await Ft(),void(Le.conferenceUrl=null);Le.conferenceUrl!==t&&(Le.conferenceUrl=t);try{const e=await Ve({url:t});if(Le.conferenceTabId=e.id,o){const e=[Zo(t)];await Le.saveBlockedInfo(null,le),await Le.saveWhitelist(e),Ht(),await Ft()}}catch(e){console.log("Cannot open tab for conference. Error="+e)}}function Zo(e){return e.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&")}async function Ko(e){let t=!1;if(Wo.isConnected){Wo.requestAppList(e.userId)&&(console.log("App list requested from native agent"),t=!0)}let o=null;const n=await De({lastFocusedWindow:!0,active:!0});n.length>0&&(o=n[0]);const s=await De({});console.log("Got "+s.length+" tabs");let r=[],i=-1;s.forEach(function(e,t){const n={id:e.id,url:e.url,title:e.title};null!=o&&e.id===o.id&&(i=t),r.push(n)}),-1!==i&&r.splice(0,0,r.splice(i,1)[0]),Ne.sendCommand({isAppListRequested:t,response:e.requestType,tabs:r,userId:e.userId})}async function en(e){console.log("Lock screen requested and confirmed"),await Le.clearWhitelist(),await Le.saveBlockedInfo(e.screenBlockMessage,ce),Ht(),Jt();try{Le.blockWindowId=await at(),await Je(Le.blockWindowId)}catch(e){console.log("Cannot create lock window: "+e)}await Ft()}async function tn(){if(console.log("Unlock requested and confirmed"),await Le.saveBlockedInfo(null,le),await Le.clearWhitelist(),Le.canvasAssignmentIds=[],Ht(),Jt(),0!==Le.blockWindowId)try{await ct(Le.blockWindowId)}catch(e){console.log("Error while closing block window: "+e)}await Ft()}async function on(e){Le.announce=e.teacherMessage,Le.teacherName=e.teacherName,Le.teacherId=e.teacherId,Ht(),await Ft(),Ne.sendCommand(ho(!1))}async function nn(e){console.log("Got blocking plan");const t=e.orgBlocklist,o=e.blockingPlanUrls,n=e.blockingPlanName,s=e.blockType;await Le.clearWhitelist(),await Le.saveOrgBlocklist(t),await Le.saveBlockingPlan(o,n,s),Ht(),await Ft(!1)}async function sn(e){console.log("Got open site command");const t=e.urls,o=await He();o&&0!==o.length?await to(t):await Fe(t)}async function rn(e){if(e.deviceId){console.log("Got screen share request"),Ht();const t={command:"requestShareScreen",userId:e.userId,deviceId:e.deviceId,lock:e.lock},o=await De({});for(const e of o)if("number"==typeof e.id)try{await ot(e.id,t)}catch(e){console.log("Error while requesting screen share: "+e)}}else Xo()}async function an(e){console.log("Got site lock command"),await Le.saveBlockedInfo(null,le),await Le.saveWhitelist(e.whitelistPatterns),Le.lockedToCourseWorkResources=!!e.courseWorkResources,Le.lockedToCourseWorkResources&&(Le.canvasAssignmentIds=ro(e.urls)),Ht(),await so(e.urls,e.closeTabs,e.notOpenTabs)}async function cn(){return new Promise(async e=>{if(console.log("Needs update check. Current version="+t),Le.updateCheckDate.getTime()<(new Date).getTime()){console.log("Checking for extension update");const e=new Date,t=10;e.setTime(e.getTime()+60*t*1e3),await Le.saveUpdateCheckDate(e),chrome.runtime.requestUpdateCheck(async e=>{switch(console.log("Update check status: "+e),e){case Te:console.log("Extension update available, will reload"),chrome.runtime.reload();break;case _e:const o=new Date;o.setTime(o.getTime()+36e5),console.log("Update check is throttled. Next check time is "+o),await Le.saveUpdateCheckDate(o),ln(60);break;default:ln(t)}})}else console.log("Next update check time is "+Le.updateCheckDate),ln();e()})}function ln(e){e||(e=5),chrome.alarms.create(ge,{delayInMinutes:e}),console.log("Schedule app restart in "+e+" minutes")}async function dn(e){Wo.requestUpgrade(e.version,e.url,e.sha)&&chrome.alarms.create(ve,{delayInMinutes:2})}const un=async function(e){lt().then(t=>{const o={response:e.requestType};Ne.sendCommand(Object.assign(o,t))}).catch(e=>{console.log("Failed to get location: "+e)})};async function hn(e){const t=e.udid;console.log("DeviceUdid set to: "+t),Me||Dt.clearBadge(),await Le.saveDeviceUdid(t)}async function mn(e){throw"function"==typeof updateContactAdminButtonVisibility?updateContactAdminButtonVisibility(!1):Dt.markNotAuthorized(),Le.loginErrorReason=e.reason,await Le.saveDeviceUdid(null),Pe&&(chrome.runtime.onMessage.addListener(go),console.log("MESSAGE LISTENER ADDED"),chrome.browserAction.onClicked.addListener(St)),await tt(),F}async function gn(e){"function"==typeof updateDeviceInfo&&updateDeviceInfo(Le.deviceUdid,e.deviceName),await Le.saveDeviceName(e.deviceName)}async function fn(e){await Le.saveServerUrl(e.serverUrl),Ne.updateUrl(e.serverUrl)}async function pn(e){const t=e.shouldSendLogs;if(void 0!==Cn&&(Cn.logEnabled=t),t?chrome.alarms.create(pe,{periodInMinutes:5}):chrome.alarms.clear(pe),void 0!==Wo&&Wo.isConnected){Wo.updateLogging(t)&&console.log("Native agent logging updated")}console.log("Logging updated to "+t+" at "+new Date)}async function wn(e){if(Pe&&(Le.studentId=e.studentId,Le.studentName=e.studentName),Me){const t=e[te],o=e[$],n=e[V],s=e[oe],r=e[ee],i=e[Z],a=e[K];await Le.saveDeviceInfo(t,o,n,s,r,i,a),updateOrgAndScreen(),updateContactAdminButtonVisibility(!0===Le.isContactAdminAllowed),updateDeviceInfo(Le.deviceUdid,o)}Le.isLoggedIn=!0,console.log("Complete login routine. Screen "+(Le.isScreenLocked?"is locked with text '"+Le.blockedText+"'":" is not locked"))}async function vn(e){const t={seq:e.seq,response:h,modeType:e.modeType};return Me&&(console.log("Enable lost mode requested and confirmed"),requestBlockScreen(e[oe],e[V],e[ee],e[K],e.allowContactAdmin),updateDeviceInfo(Le.deviceUdid,Le.deviceName),updateSyncDate(),await Le.saveBlockedInfo(e[oe],e[V],e[ee],e[K],e[Z])),t}async function bn(e){let t=!1;if(Wo.isConnected){const o=Nt(e.url);t=Wo.requestScreenshot(o,e.maxWidth,e.maxHeight)}t?console.log("Screenshot requested from native agent"):yn(e)}async function yn(e){console.log("Screenshot requested");const t=await De({currentWindow:!0,active:!0});if(t.length>0){const o=t[0].url,n=t[0].title;try{const t=null!==Le.capturedScreen?Le.capturedScreen:await Qe();void 0!==o&&(e.tabUrl=o),void 0!==n&&(e.tabTitle=n),Lt(t,e)}catch(e){console.log("Error capture visible tab: "+e)}}else console.log("No tabs found to capture")}Ee.chrome_auth_confirm=hn,Ee[w]=gn,Ee.chrome_change_server_url=fn,Ee[b]=mn,Ee[y]=un,Ee[C]=pn,Ee.chrome_login_confirmation=wn,Ee[q]=bn,Ee.chrome_blocking_plan=nn,Ee[T]=zo,Ee.chrome_session=jo,Ee.chrome_session_update=Vo,Ee.chrome_clear_raised_hand=Yo,Ee[A]=Bo,Ee.chrome_close_tab=Fo,Ee.chrome_focus_tab=Jo,Ee.chrome_get_tabs=Ko,Ee.chrome_lock_screen=en,Ee.chrome_open_site=sn,Ee[x]=rn,Ee.chrome_site_lock=an,Ee[D]=on,Ee.chrome_unlock=tn,Ee.chrome_teacher_screen_share=$o,Ee.chrome_windows_agent_upgrade=dn,st();const kn=console.log;function Cn(e){if("function"==typeof kn&&kn.apply(this,arguments),Cn.logEnabled){const t="/agent/chrome/debug",o=new XMLHttpRequest;if(o.timeout=ye,o.ontimeout=function(){kn.apply(null,["Timeout while sending logs to the server"])},Le){const n=Le.deviceUdid?Le.deviceUdid:Le.directoryDeviceId,s=Le.serverUrl+t;o.open("POST",s),o.setRequestHeader(be,n),o.setRequestHeader("Content-Type","application/json; charset=UTF-8");const r={udid:n,logNum:Cn.logCount,logString:e,logSource:"extension"};Cn.logCount+=1,o.send(JSON.stringify(r))}}}console.log=Cn,Cn.logEnabled=!0,Cn.logCount=0;